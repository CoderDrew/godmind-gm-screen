!function(){"use strict";class t{constructor(){this.cache=new Map,this.loadingPromises=new Map}get(t){return this.cache.get(t)||{state:"none",buffer:null,error:null}}async load(t,e,i){if(this.loadingPromises.has(e))return this.loadingPromises.get(e);const a=this.cache.get(e);if(a&&"ready"===a.state)return Promise.resolve(a.buffer);this.cache.set(e,{state:"loading",buffer:null,error:null});const s=performance.now();console.log(`[AudioCache] Loading track ${e}...`);const r=(async()=>{try{const a=performance.now(),r=await fetch(i),n=performance.now()-a,o=await r.arrayBuffer(),c=(performance.now(),performance.now()),l=await t.decodeAudioData(o),d=performance.now()-c,u=performance.now()-s;return console.log(`[AudioCache] âœ“ Track ${e} ready - Fetch: ${n.toFixed(0)}ms, Decode: ${d.toFixed(0)}ms, Total: ${u.toFixed(0)}ms`),this.cache.set(e,{state:"ready",buffer:l,error:null}),this.loadingPromises.delete(e),l}catch(t){throw console.error(`[AudioCache] âœ— Track ${e} failed:`,t),this.cache.set(e,{state:"error",buffer:null,error:t}),this.loadingPromises.delete(e),t}})();return this.loadingPromises.set(e,r),r}isReady(t){const e=this.cache.get(t);return e&&"ready"===e.state}async preloadBatch(t,e){const i=e.map(({id:e,url:i})=>{if(!this.isReady(e))return this.load(t,e,i).catch(()=>{})});return Promise.all(i)}}class e{constructor(){this.audioContext=null,this.activeTracks=new Map,this.masterGainNode=null,this.duckingGainNode=null,this.duckAmount=.3,this.bufferCache=new t,this.allTracks=[],this.init()}init(){const t=()=>{this.ensureAudioContext(),console.log("[AudioEngine] AudioContext initialized on first interaction")};document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",t,{once:!0})}ensureAudioContext(){return this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGainNode=this.audioContext.createGain(),this.duckingGainNode=this.audioContext.createGain(),this.masterGainNode.connect(this.duckingGainNode),this.duckingGainNode.connect(this.audioContext.destination),console.log("[AudioEngine] AudioContext created and ready")),"suspended"===this.audioContext.state&&this.audioContext.resume(),this.audioContext}registerTracks(t){this.allTracks=t}async preloadByType(t){this.ensureAudioContext();const e=this.allTracks.filter(e=>e.type===t).map(t=>({id:t.id,url:t.url}));return console.log(`[AudioEngine] Preloading ${e.length} ${t} tracks...`),this.bufferCache.preloadBatch(this.audioContext,e)}async preload(t,e){return this.ensureAudioContext(),this.bufferCache.load(this.audioContext,t,e)}async play(t,e){const i=performance.now();this.ensureAudioContext();const{url:a,type:s,volume:r,loop:n}=e;"music"===s&&await this.stopAllTracksOfType("music"),this.activeTracks.has(t)&&await this.stop(t);try{const o=this.bufferCache.get(t);let c;"ready"===o.state?(c=o.buffer,console.log(`[AudioEngine] âš¡ Instant play from cache - Track ${t}`)):(console.log(`[AudioEngine] â³ Loading before playback - Track ${t}`),c=await this.bufferCache.load(this.audioContext,t,a));const l=this.audioContext.createBufferSource(),d=this.audioContext.createGain();l.buffer=c,l.loop=n;const u=r/100;d.gain.setValueAtTime(u,this.audioContext.currentTime),l.connect(d),d.connect(this.masterGainNode),l.start(0);const h=performance.now()-i;return console.log(`[AudioEngine] ðŸ”Š Audio started - Time to playback: ${h.toFixed(0)}ms`),this.activeTracks.set(t,{source:l,gainNode:d,audioBuffer:c,type:s,loop:n,volume:r,startTime:this.audioContext.currentTime,pauseTime:0}),"sfx"===s&&(l.onended=()=>{this.activeTracks.delete(t),this.unduckMusic()},this.duckMusic()),this.smartPreload(e),!0}catch(t){return console.error("[AudioEngine] Play error:",t),!1}}async smartPreload(t){const e=this.allTracks.filter(e=>e.type===t.type&&e.id!==t.id).slice(0,3).map(t=>({id:t.id,url:t.url}));e.length>0&&this.bufferCache.preloadBatch(this.audioContext,e).catch(()=>{})}async stop(t){const e=this.activeTracks.get(t);if(!e)return;const{source:i,type:a}=e;try{i.stop()}catch(t){}this.activeTracks.delete(t),"sfx"===a&&this.unduckMusic()}async stopAllTracksOfType(t){const e=[];for(const[i,a]of this.activeTracks.entries())a.type===t&&e.push(this.stop(i));await Promise.all(e)}setVolume(t,e){const i=this.activeTracks.get(t);if(!i)return;const a=e/100;i.gainNode.gain.linearRampToValueAtTime(a,this.audioContext.currentTime+.1),i.volume=e}setLoop(t,e){const i=this.activeTracks.get(t);i&&i.source&&(i.source.loop=e,i.loop=e)}isPlaying(t){return this.activeTracks.has(t)}getProgress(t){const e=this.activeTracks.get(t);if(!e)return{current:0,duration:0};const i=this.audioContext.currentTime-e.startTime,a=e.audioBuffer.duration;return{current:Math.min(i,a),duration:a}}duckMusic(){this.duckingGainNode&&this.duckingGainNode.gain.linearRampToValueAtTime(this.duckAmount,this.audioContext.currentTime+.2)}unduckMusic(){if(!this.duckingGainNode)return;let t=!1;for(const e of this.activeTracks.values())if("sfx"===e.type){t=!0;break}t||this.duckingGainNode.gain.linearRampToValueAtTime(1,this.audioContext.currentTime+.2)}getDuration(t){return t?t.duration:0}getCachedBuffer(t){const e=this.bufferCache.get(t);return"ready"===e.state?e.buffer:null}isBufferReady(t){return this.bufferCache.isReady(t)}}class i{constructor(){this.favorites=this.loadFavorites(),this.recentlyPlayed=this.loadRecentlyPlayed(),this.maxRecent=8}loadFavorites(){try{const t=localStorage.getItem("godmind_track_favorites");return t?JSON.parse(t):[]}catch(t){return[]}}saveFavorites(){try{localStorage.setItem("godmind_track_favorites",JSON.stringify(this.favorites))}catch(t){console.error("Failed to save favorites:",t)}}toggleFavorite(t){const e=this.favorites.indexOf(t);return e>-1?this.favorites.splice(e,1):this.favorites.push(t),this.saveFavorites(),this.isFavorite(t)}isFavorite(t){return this.favorites.includes(t)}loadRecentlyPlayed(){try{const t=localStorage.getItem("godmind_recently_played");return t?JSON.parse(t):[]}catch(t){return[]}}saveRecentlyPlayed(){try{localStorage.setItem("godmind_recently_played",JSON.stringify(this.recentlyPlayed))}catch(t){console.error("Failed to save recently played:",t)}}addToRecentlyPlayed(t,e){this.recentlyPlayed=this.recentlyPlayed.filter(e=>e.id!==t),this.recentlyPlayed.unshift({id:t,title:e.title,type:e.type,timestamp:Date.now()}),this.recentlyPlayed.length>this.maxRecent&&(this.recentlyPlayed=this.recentlyPlayed.slice(0,this.maxRecent)),this.saveRecentlyPlayed()}getRecentlyPlayed(){return this.recentlyPlayed}}class a{constructor(t,e){this.audioEngine=t,this.state=e,this.trackCards=new Map,this.currentFilter="all",this.searchQuery="",this.favoritesOnly=!1,this.progressIntervals=new Map,this.init()}init(){this.cacheElements(),this.bindEvents(),this.initializeCards(),this.updateRecentlyPlayedUI(),this.startSmartPreloading()}cacheElements(){this.trackGrid=document.querySelector(".track-grid"),this.searchInput=document.getElementById("track-search"),this.filterButtons=document.querySelectorAll(".filter-btn"),this.favoritesToggle=document.getElementById("favorites-toggle"),this.recentlyPlayedList=document.querySelector(".recently-played-list")}bindEvents(){this.searchInput&&this.searchInput.addEventListener("input",t=>{this.searchQuery=t.target.value.toLowerCase(),this.applyFilters()}),this.filterButtons.forEach(t=>{t.addEventListener("click",t=>{this.filterButtons.forEach(t=>t.classList.remove("active")),t.target.classList.add("active"),this.currentFilter=t.target.dataset.filter,this.applyFilters(),"all"!==this.currentFilter&&this.audioEngine.preloadByType(this.currentFilter)})}),this.favoritesToggle&&this.favoritesToggle.addEventListener("change",t=>{this.favoritesOnly=t.target.checked,this.applyFilters()})}initializeCards(){const t=document.querySelectorAll(".track-card"),e=[];t.forEach(t=>{const i=t.dataset.trackId,a={id:i,title:t.querySelector(".track-title").textContent,url:t.dataset.src,type:t.dataset.trackType,volume:parseInt(t.dataset.defaultVolume,10),loop:"true"===t.dataset.loop,purpose:t.dataset.purpose,scene:t.dataset.scene};e.push(a),this.trackCards.set(i,{card:t,trackData:a}),this.bindCardEvents(t,i,a),this.updateFavoriteUI(t,i),this.loadDuration(t,a)}),this.audioEngine.registerTracks(e)}async startSmartPreloading(){await(()=>new Promise(t=>{const e=setInterval(()=>{this.audioEngine.audioContext&&(clearInterval(e),t())},100)}))(),console.log("[Preloader] Starting smart preload strategy...");const t=this.state.getRecentlyPlayed().map(t=>t.id).slice(0,3);for(const e of t){const t=this.trackCards.get(e);t&&this.audioEngine.preload(t.trackData.id,t.trackData.url)}const e=this.state.favorites.slice(0,3);for(const t of e){const e=this.trackCards.get(t);e&&this.audioEngine.preload(e.trackData.id,e.trackData.url)}setTimeout(()=>{this.audioEngine.preloadByType("ambient")},2e3)}bindCardEvents(t,e,i){const a=t.querySelector(".track-btn-play"),s=t.querySelector(".track-btn-pause"),r=t.querySelector(".track-btn-restart"),n=t.querySelector(".track-btn-loop"),o=t.querySelector(".track-btn-favorite"),c=t.querySelector(".volume-slider"),l=t.querySelector(".volume-value");t.addEventListener("mouseenter",()=>{this.audioEngine.isBufferReady(e)||this.audioEngine.preload(e,i.url)},{once:!0}),a?.addEventListener("click",async()=>{await this.audioEngine.play(e,i)&&(this.updatePlayingUI(t,!0),this.state.addToRecentlyPlayed(e,i),this.updateRecentlyPlayedUI(),this.startProgressTracking(t,e))}),s?.addEventListener("click",async()=>{await this.audioEngine.stop(e),this.updatePlayingUI(t,!1),this.stopProgressTracking(e)}),r?.addEventListener("click",async()=>{const a=this.audioEngine.isPlaying(e);await this.audioEngine.stop(e),a&&await this.audioEngine.play(e,i)&&(this.updatePlayingUI(t,!0),this.startProgressTracking(t,e))}),n?.addEventListener("click",()=>{if("ambient"===i.type)return;const t=!n.classList.contains("active");n.classList.toggle("active"),i.loop=t,this.audioEngine.setLoop(e,t)}),o?.addEventListener("click",()=>{this.state.toggleFavorite(e),this.updateFavoriteUI(t,e),this.state.isFavorite(e)&&this.audioEngine.preload(e,i.url)}),c?.addEventListener("input",t=>{const a=parseInt(t.target.value,10);i.volume=a,l.textContent=`${a}%`,this.audioEngine.setVolume(e,a)})}updatePlayingUI(t,e){const i=t.querySelector(".track-btn-play"),a=t.querySelector(".track-btn-pause");e?(i?.classList.add("hidden"),a?.classList.remove("hidden"),t.classList.add("is-playing")):(i?.classList.remove("hidden"),a?.classList.add("hidden"),t.classList.remove("is-playing"))}updateFavoriteUI(t,e){const i=t.querySelector(".track-btn-favorite"),a=i?.querySelector(".icon-favorite");this.state.isFavorite(e)?(i?.classList.add("active"),a&&(a.textContent="â˜…")):(i?.classList.remove("active"),a&&(a.textContent="â˜†"))}async loadDuration(t,e){const i=this.audioEngine.getCachedBuffer(e.id);if(i)this.displayDuration(t,i.duration);else try{await this.audioEngine.ensureAudioContext();const i=await this.audioEngine.preload(e.id,e.url);this.displayDuration(t,i.duration)}catch(t){console.error("Failed to load duration:",t)}}displayDuration(t,e){const i=t.querySelector(".duration-value");i&&(i.textContent=this.formatTime(e));const a=t.querySelector(".time-total");a&&(a.textContent=this.formatTime(e))}startProgressTracking(t,e){this.stopProgressTracking(e);const i=setInterval(()=>{const i=this.audioEngine.getProgress(e);this.updateProgressUI(t,i),this.audioEngine.isPlaying(e)||(this.stopProgressTracking(e),this.updatePlayingUI(t,!1))},100);this.progressIntervals.set(e,i)}stopProgressTracking(t){const e=this.progressIntervals.get(t);e&&(clearInterval(e),this.progressIntervals.delete(t))}updateProgressUI(t,e){const i=t.querySelector(".progress-fill"),a=t.querySelector(".time-current");if(i&&e.duration>0){const t=e.current/e.duration*100;i.style.width=`${t}%`}a&&(a.textContent=this.formatTime(e.current))}formatTime(t){return`${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,"0")}`}applyFilters(){this.trackCards.forEach(({card:t,trackData:e},i)=>{let a=!0;"all"!==this.currentFilter&&e.type!==this.currentFilter&&(a=!1),this.searchQuery&&([e.title,e.purpose,e.scene].join(" ").toLowerCase().includes(this.searchQuery)||(a=!1)),this.favoritesOnly&&!this.state.isFavorite(i)&&(a=!1),t.style.display=a?"":"none"})}updateRecentlyPlayedUI(){if(!this.recentlyPlayedList)return;const t=this.state.getRecentlyPlayed();0!==t.length?(this.recentlyPlayedList.innerHTML=t.map(t=>`\n                <div class="recent-track-item" data-track-id="${t.id}">\n                    <span class="recent-track-title">${this.escapeHtml(t.title)}</span>\n                    <span class="recent-track-type track-type-${t.type}">${t.type}</span>\n                </div>\n            `).join(""),this.recentlyPlayedList.querySelectorAll(".recent-track-item").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.trackId,i=this.trackCards.get(e);i&&(i.card.scrollIntoView({behavior:"smooth",block:"center"}),i.card.classList.add("highlight"),setTimeout(()=>i.card.classList.remove("highlight"),2e3))})})):this.recentlyPlayedList.innerHTML='<p class="recently-played-empty">No tracks played yet</p>'}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}function s(){const t=new e,s=new i,r=new a(t,s);window.godmindDebug&&(window.godmindTrackArchive={audioEngine:t,state:s,ui:r})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s()}();